# Supabase Schema and RLS for Jaib Application

This document outlines the PostgreSQL schema and Row Level Security (RLS) policies implemented in Supabase for the Jaib application. The schema is designed to support storing user-saved articles, tagging, and annotations.

## General Principles

- **UUIDs for Primary Keys**: All primary keys (`id` columns) use `UUID` generated by `gen_random_uuid()` for globally unique identifiers.
- **User Scoping**: All data is scoped to the authenticated user. RLS policies ensure users can only access and manage their own data. `(select auth.uid())` is used in RLS policies to refer to the ID of the currently authenticated user.
- **Cascade Deletes**: Foreign key constraints generally use `ON DELETE CASCADE` to maintain data integrity. For example, if a user is deleted, their articles, tags, and annotations are also deleted. If an article is deleted, its associated tags and annotations are also removed.

## Table Schemas and RLS Policies

### 1. `public.articles`

Stores the articles saved by users. Each row represents a unique article saved by a specific user.

**Purpose**: To hold the main content and metadata of articles that users have saved.

**Columns**:

| Column Name         | Data Type                 | Constraints/Defaults                       | Description                                                                        |
| ------------------- | ------------------------- | ------------------------------------------ | ---------------------------------------------------------------------------------- |
| `id`                | `UUID`                    | `PRIMARY KEY`, `DEFAULT gen_random_uuid()` | Unique identifier for the saved article instance.                                  |
| `user_id`           | `UUID`                    | `NOT NULL`, `FK -> auth.users(id)`         | The user who saved this article.                                                   |
| `title`             | `TEXT`                    | `NOT NULL`                                 | Title of the article.                                                              |
| `content`           | `TEXT`                    | `NOT NULL`                                 | Full HTML content of the article (parsed).                                         |
| `url`               | `TEXT`                    | `NOT NULL`                                 | Original URL of the article.                                                       |
| `excerpt`           | `TEXT`                    |                                            | A short summary or excerpt of the article.                                         |
| `byline`            | `TEXT`                    |                                            | Author or byline of the article.                                                   |
| `length`            | `INTEGER`                 |                                            | Estimated length of the article (e.g., word count or reading time in minutes).     |
| `saved_at`          | `TIMESTAMPTZ`             | `NOT NULL`, `DEFAULT now()`                | Timestamp of when the article was saved.                                           |
| `is_favorite`       | `BOOLEAN`                 | `NOT NULL`, `DEFAULT FALSE`                | Indicates if the user has marked the article as a favorite.                        |
| `is_read`           | `BOOLEAN`                 | `DEFAULT FALSE`                            | Indicates if the user has marked the article as read (archived).                   |
| `lead_image_url`    | `TEXT`                    |                                            | URL of the lead image for the article.                                             |
| `site_name`         | `TEXT`                    |                                            | Name of the website or source of the article.                                      |
| `raw_content_error` | `BOOLEAN`                 | `DEFAULT FALSE`                            | Flag to indicate if there was an error fetching/parsing the raw content initially. |
| _Constraint_        | `unique_user_article_url` | `UNIQUE (user_id, url)`                    | Ensures a user cannot save the same article URL multiple times.                    |

**RLS Policies**:

- Enabled.
- **"Users can select their own articles"**: Allows users to `SELECT` only their own articles.
- **"Users can insert their own articles"**: Allows users to `INSERT` articles, automatically setting `user_id` to their `auth.uid()`.
- **"Users can update their own articles"**: Allows users to `UPDATE` only their own articles.
- **"Users can delete their own articles"**: Allows users to `DELETE` only their own articles.

---

### 2. `public.tags`

Stores tags created by users for categorizing articles.

**Purpose**: To allow users to create and manage a personal set of tags.

**Columns**:

| Column Name  | Data Type              | Constraints/Defaults                       | Description                                               |
| ------------ | ---------------------- | ------------------------------------------ | --------------------------------------------------------- |
| `id`         | `UUID`                 | `PRIMARY KEY`, `DEFAULT gen_random_uuid()` | Unique identifier for the tag.                            |
| `user_id`    | `UUID`                 | `NOT NULL`, `FK -> auth.users(id)`         | The user who created this tag.                            |
| `name`       | `TEXT`                 | `NOT NULL`                                 | The name of the tag (e.g., "Technology", "Productivity"). |
| `created_at` | `TIMESTAMPTZ`          | `NOT NULL`, `DEFAULT now()`                | Timestamp of when the tag was created.                    |
| _Constraint_ | `unique_user_tag_name` | `UNIQUE (user_id, name)`                   | Ensures a tag name is unique for a given user.            |

**RLS Policies**:

- Enabled.
- **"Users can select their own tags"**: Allows `SELECT` of own tags.
- **"Users can insert their own tags"**: Allows `INSERT` of tags for oneself.
- **"Users can update their own tags"**: Allows `UPDATE` of own tags (e.g., renaming).
- **"Users can delete their own tags"**: Allows `DELETE` of own tags.

---

### 3. `public.article_tags`

A join table to create a many-to-many relationship between articles and tags.

**Purpose**: To link specific articles with specific tags, as defined by the user.

**Columns**:

| Column Name   | Data Type         | Constraints/Defaults                        | Description                                                                |
| ------------- | ----------------- | ------------------------------------------- | -------------------------------------------------------------------------- |
| `article_id`  | `UUID`            | `NOT NULL`, `FK -> public.articles(id)`     | Foreign key referencing the article being tagged.                          |
| `tag_id`      | `UUID`            | `NOT NULL`, `FK -> public.tags(id)`         | Foreign key referencing the tag being applied.                             |
| `user_id`     | `UUID`            | `NOT NULL`, `FK -> auth.users(id)`          | The user who made this article-tag association.                            |
| `assigned_at` | `TIMESTAMPTZ`     | `NOT NULL`, `DEFAULT now()`                 | Timestamp of when the tag was assigned to the article.                     |
| _Constraint_  | `pk_article_tags` | `PRIMARY KEY (user_id, article_id, tag_id)` | Ensures a tag is not applied multiple times to the same article by a user. |

**RLS Policies**:

- Enabled.
- **"Users can select their own article-tag links"**: Allows `SELECT` of own article-tag associations.
- **"Users can insert their own article-tag links"**: Allows `INSERT` of links, checking that the user owns both the article and the tag being linked.
- **"Users can delete their own article-tag links"**: Allows `DELETE` of own article-tag associations.

---

### 4. `public.annotations`

Stores user-specific highlights and notes on articles.

**Purpose**: To allow users to select portions of article text, highlight them, and optionally add a note.

**Columns**:

| Column Name     | Data Type     | Constraints/Defaults                       | Description                                                                                                    |
| --------------- | ------------- | ------------------------------------------ | -------------------------------------------------------------------------------------------------------------- |
| `id`            | `UUID`        | `PRIMARY KEY`, `DEFAULT gen_random_uuid()` | Unique identifier for the annotation.                                                                          |
| `article_id`    | `UUID`        | `NOT NULL`, `FK -> public.articles(id)`    | Foreign key referencing the article that is annotated.                                                         |
| `user_id`       | `UUID`        | `NOT NULL`, `FK -> auth.users(id)`         | The user who created this annotation.                                                                          |
| `selector_info` | `JSONB`       | `NOT NULL`                                 | JSONB object storing data to precisely locate the annotation (e.g., text quote, start/end offsets, selectors). |
| `note`          | `TEXT`        |                                            | An optional textual note or comment accompanying the highlight.                                                |
| `created_at`    | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT now()`                | Timestamp of when the annotation was created.                                                                  |
| `updated_at`    | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT now()`                | Timestamp of when the annotation was last updated.                                                             |

**RLS Policies**:

- Enabled.
- **"Users can select their own annotations"**: Allows `SELECT` of own annotations.
- **"Users can insert their own annotations"**: Allows `INSERT` of annotations, checking that the user owns the article being annotated.
- **"Users can update their own annotations"**: Allows `UPDATE` of own annotations (e.g., editing the note).
- **"Users can delete their own annotations"**: Allows `DELETE` of own annotations.

## Relationships Summary

- A `user` (from `auth.users`) can have many `articles`.
- A `user` can create many `tags`.
- An `article` can have many `tags` applied to it by its `user_id` owner, and a `tag` can be applied to many `articles` owned by its `user_id` owner. This many-to-many relationship is managed through the `article_tags` join table.
- An `article` can have many `annotations` made by its `user_id` owner.

This schema provides a robust foundation for the core features of the Jaib application.
